<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>테트리스</title>
</head>
<body>
    <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
    <script>
        var init=false;
var myCanvas;
var Context;
var square;
var square_boxsize=25;
var square_top=50;
var square_left=280;
var square_in;
var square_in_this;




function square_in_init()
{
    square_in=new Array(); //블럭
    
    tmp=new Array();
    tmp.push(0,0);tmp.push(0,1);tmp.push(0,2);tmp.push(0,3);
    square_in.push(tmp);
    
    tmp=new Array();
    tmp.push(0,0);tmp.push(0,1);tmp.push(0,2);tmp.push(1,1);
    square_in.push(tmp);
    
    tmp=new Array();
    tmp.push(0,0);tmp.push(0,1);tmp.push(1,1);tmp.push(1,2);
    square_in.push(tmp);
    
    tmp=new Array();
    tmp.push(0,1);tmp.push(0,2);tmp.push(1,0);tmp.push(1,1);
    square_in.push(tmp);
    
    tmp=new Array();
    tmp.push(0,0);tmp.push(0,1);tmp.push(0,2);tmp.push(1,0);
    square_in.push(tmp);

    tmp=new Array();
    tmp.push(0,0);tmp.push(0,1);tmp.push(0,2);tmp.push(1,2);
    square_in.push(tmp);

    tmp=new Array();
    tmp.push(0,0);tmp.push(0,1);tmp.push(1,0);tmp.push(1,1);
    square_in.push(tmp);
}

var square_in_number=3;
var square_x=3;
var square_y=0;

function Init()
{
    if(init==false)
    {
        myCanvas=document.getElementById("MyCanvas")
        Context=myCanvas.getContext("2d");
        init=true;
        square_init();
        square_in_init();
        square_in_number=Math.floor(Math.random()*6.9);
        square_in_this=square_in[square_in_number].slice();
        
    }
}
function square_init()
{
    square=new Array();
    for(i=0;i<20;++i) //전위 연산자
    {
        square.push(new Array(10));
        for(j=0;j<10;++j)
        square[i][j]=0; //배열 초기화
    }
}
function Run()
{
        var size=square_in_this.length;
        square_y++;
        if(CheckConflict()) //겹침
        {
            square_y--;
            for(k=0;k<size;k+=2)
            {
            check_y = square_y + square_in_this[k];
            check_x = square_x + square_in_this[k+1];
            square[check_y][check_x]=1;
            }

            square_y=0;
            square_x=3;

            square_in_number=Math.floor(Math.random()*6.9);
            square_in_this=square_in[square_in_number].slice();           
	    }
        onDraw();
}

function onDraw()
    {
        if(init==false)return;

        Context.strokeStyle="#000"; //선 색상
        Context.lineWidth=1; //선 두께
		Context.strokeRect(0, 0, myCanvas.width-1, myCanvas.height-1); //테두리만 있는 사각형
		
		
		for(i=0;i<20;++i)
			for(j=0;j<10;++j)
			{
				if(square[i][j]==0)
				Context.fillStyle="#D8D8D8"; //색깔
			else
                Context.fillStyle="green";
                
                var size=square_in_this.length; //떨어지는 블럭 검사
                for(k=0;k<size;k+=2)
                {
                    if(square_y + square_in_this[k] == i
                        && square_x + square_in_this[k+1] == j)
                        Context.fillStyle='blue'
                }
			    x=square_left + j*square_boxsize;
			    y=square_top + i*square_boxsize;
			    Context.fillRect(x, y, square_boxsize-2,square_boxsize-2); //사각형 그리기
			}
    }

function onKeyDown(event)
{
        if(event.which==37)
        {   
        square_x--;
        if(CheckConflict())square_x++;
        else
            onDraw();
    }
    
    if(event.which==40 || event.which==32)
    {   
        square_y++;
        if(CheckConflict())square_y--;
        else
            onDraw();
    }

    if(event.which==39)
    {   
        square_x++;
        if(CheckConflict())square_x--;
        else
            onDraw();
    }
    
    if(event.which==38)
    {   
        Rotateblock();
        onDraw();
    }

}
function Rotateblock()
{
    switch(square_in_number)
	{
		case 0: case 1: case 2: case 3: case 4: case 5: // 0~5 블럭모양
			centerY=0; centerX=1;
			break;
		case 6: // 6 블럭모양
			return;
	}
	square_in_save = square_in_this.slice();
	for(i=0;i<square_in_this.length;i+=2)
	{
		y=square_in_this[i+1] - centerX;
		x= -(square_in_this[i] - centerY);
		square_in_this[i]=y + centerY;
		square_in_this[i+1]=x + centerX;
	}
	if(CheckConflict())
		square_in_this=square_in_save.slice();
}

function CheckConflict()
{
    var size=square_in_this.length;
    for(k=0;k<size;k+=2)
    {
        check_y=square_y + square_in_this[k];
        check_x=square_x + square_in_this[k+1];
        if(check_x < 0 || check_x >=10 || check_y >=20 || square[check_y][check_x]!=0)return true;
    }
    return false;

}
	
	
	$(document).ready(function(){ //자동 실행 함수
		Init();
		setInterval(Run,500); //내부 함수 주기적으로 실행
    });
    $(document).keydown(function(event){
        onKeyDown(event);
    });
    </script>
<canvas id='MyCanvas' width="800" height="600">CANVAS</canvas>
</body>

</html>